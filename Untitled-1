router.post('/business/create-business', upload.single('photo'), function(req, res){
  if (req.file !== undefined){
    var target_path = '/files/' + req.file.filename;
    var file_name = req.file.filename,
      original_name = !req.file ? 'placeholder.jpg' : req.file.originalname,
      mime_type = req.file.mimetype
  }
  else {
    var target_path = 'https://png.icons8.com/ios/50/000000/link-company-parent.png';
    var file_name = null,
      original_name = null,
      mime_type = null
  }
  validateJoi.validate({ 
    // category: req.body.category, 
    name: req.body.name, 
    email: req.body.email, phone_number: req.body.phone_number, website: req.body.website, 
    description: req.body.description, line1: req.body.line1, line2: req.body.line2,
    adm_area_lv1: req.body.adm_area_lv1, adm_area_lv2: req.body.adm_area_lv2, 
    adm_area_lv3: req.body.adm_area_lv3, adm_area_lv4: req.body.adm_area_lv4, 
    postal_code: req.body.postal_code, lat: req.body.lat, lng: req.body.lng}, function(errors, value) {
      console.log(errors);
      if (!errors) {
        address.create({
          line1: req.body.line1, 
          line2: req.body.line2,
          adm_area_lv1: req.body.adm_area_lv1, 
          adm_area_lv2: req.body.adm_area_lv2, 
          adm_area_lv3: req.body.adm_area_lv3, 
          adm_area_lv4: req.body.adm_area_lv4, 
          raw_address: req.body.line1+ ` ` +req.body.line2,
          formatted_address: req.body.formatted_address,
          postal_code: req.body.postal_code,
          country: req.body.country,
          //Sequelize.fn('ST_GeomFromText', 'POINT(-7.778737 110.389407)')
          location: Sequelize.fn('ST_GeomFromText', `POINT(`+req.body.lat+` `+req.body.lng+`)`)
        }, {
          include: [{
            model: business
          }]
        }
      )
      .then(row => {
        file.create({
          name: filename,
          relative_path: target_path,
          original_name: original_name,
          mime_type : mime_type
        }, {
          include: [{
            model: business
          }]
        })
        .then(row => {
          // console.log(row);
          // console.log(req.file);
          business.create({
            userId: req.user.id,
            name: req.body.name,
            addressId: row.id,
            fileId: row.id,
            email: req.body.email,
            phone_number: req.body.phone_number,
            website: req.body.website,
            description: req.body.description
          }, {
            include: [{
              model: helper_category
            }]
          })
          .then(row => {
            for(var i = 0; i < req.body.category.length; i++ ) {
              helper_category.create({
                categoryId: req.body.category[i],
                businessId: row.id
              })
            }
          })
          .then(rows => {
            console.log(rows);
            res.redirect('/business-owner/business');
          })
        }) 
      })
    } else {
      category.findAll()
      .then(rows => {
        //if (err) return err;
        res.render('business-owner/create-business', {title: 'Create Business | Outlet Finder', categories:rows, active3: 'active-navbar', name: req.user.first_name + ' ' + req.user.last_name, photo:req.user[`file.pp`]});
      })
    } 
  })
});
